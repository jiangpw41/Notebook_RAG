<!-- JPW的Markdown笔记模板 v1, 其中的href需要视情更改上级目录href="../../format.css -->
<link rel="stylesheet" type="text/css" href="../../format.css">


<h1>RAG系列：相似度与返回策略</h1>

💡 基于特定的相似度策略，返回一组指定形式的chunk（topk, threshold, rerank等）

在使用阶段，对每个用户输入的查询文本用相同的embedding模型进行嵌入，得到Q，数据库则会根据预先设定的检索策略（向量距离/相似度策略、topk策略等）返回与Q相似度最高的一组chunk。稀疏向量主要针对的是向量中大部分元素为零的情况，因此通过仅存储非零元素及其索引来节省存储空间和计算资源。对于稠密向量，即向量中大部分元素非零的情况，使用稀疏向量的存储和计算方法可能并不高效。因为稠密向量的每个元素都对整体有所贡献，存储索引会增加额外的开销，而且在计算相似度时，需要遍历所有元素，这使得稀疏向量的优化策略失效。

# 1 相似度算法
- **余弦相似度（Cosine Similarity）**：计算两个向量之间的夹角余弦值来衡量它们的相似程度，$Cosine Similarity(A,B)=\frac{A⋅B}{∥A∥∥B∥}​$
- **欧氏距离（Euclidean Distance）**：表示两个向量在n维空间中的直线距离，是n个维度上所有数值差的平方之和总体开平方。$(\sum_{i=1}^n​∣a_i​−b_i​|^2)^{(1/2)}$
- **点积（Dot Product）**：点积衡量两个向量的长度和夹角的乘积，公式为$a·b = \sum_{i=1}^na_ib_i$，适用于高维空间的相似性计算。通过最大内积MIP（Maximum Inner Product）进行检索。
- **曼哈顿距离（Manhattan Distance）**：城市街区距离，它表示两个向量在n维空间中各维度上绝对差值之和。$\sum_{i=1}^n​∣a_i​−b_i​|$
- **闵可夫斯基距离（Minkowski Distance）**：欧氏距离和曼哈顿距离的广义形式，公式为：$d(a,b)=(\sum_{i=1}^n​∣a_i​−b_i​|^p)^{(1/p)}$
- **Jaccard相似系数（Jaccard Similarity Coefficient）**：衡量两个集合的相似度，特别适用于处理稀疏数据集。它定义为两个集合交集的大小除以并集的大小。在向量场景下，可视为将向量看作集合，非零元素为集合中的元素
- **汉明距离（Hamming Distance）**：两个等长向量在相同位置上不同值的个数

# 返回策略
主要包括三种
- 置信度：包括阈值筛选、置信度归一化等
- topk：返回的chunk数量
- Rerank重排序：将检索到的一组chunk根据与Query的相关性进行排序。